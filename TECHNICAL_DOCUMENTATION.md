# 智能捕蚊识别系统技术文档

## 1. 项目概述

智能捕蚊识别系统是一个基于物联网技术的智能设备管理平台，用于实时监控、管理和分析捕蚊设备采集的数据和图片。

### 1.1 项目目标
- 实现捕蚊设备的实时监控
- 支持图片上传、查看和删除功能
- 提供设备管理和用户权限控制
- 实现数据可视化和实时推送

### 1.2 技术栈
- **前端**: HTML5, CSS3, JavaScript, Socket.IO
- **后端**: Flask, Python, Socket.IO, SQLite
- **通信协议**: HTTP, WebSocket, MQTT
- **开发环境**: Python 3.12, Flask 3.1.2

## 2. 系统架构

### 2.1 整体架构
```
+------------------+     +------------------+     +------------------+
|    捕蚊设备      |     |    后端服务器     |     |    前端浏览器    |
+------------------+     +------------------+     +------------------+
        |                         |                         |
        |  MQTT 通信              |  WebSocket 实时推送     |
        +------------------------>|------------------------>+ 实时数据展示
        |  图片上传               |  API 接口               | 设备管理
        +------------------------>|------------------------>+ 图片查看
        |                         |  数据库存储             | 图片删除
        |                         +------------------------>+ 登录认证
```

### 2.2 目录结构
```
/opt/iot_app/
├── app.py                # 主应用程序文件
├── mqtt_receiver.py      # MQTT消息接收处理
├── mqtt_server.py        # MQTT服务器实现
├── static/
│   └── index.html        # 前端页面
├── TECHNICAL_DOCUMENTATION.md  # 技术文档
├── test_db.py            # 数据库测试脚本
├── venv/                 # Python虚拟环境
└── .gitignore            # Git忽略文件配置
```

## 3. 核心功能模块

### 3.1 用户认证模块
- **功能描述**: 实现用户登录、权限控制和会话管理
- **支持的用户角色**:
  - 管理员: 管理所有设备和用户
  - 设备: 设备端数据上传
- **认证方式**: 基于会话的认证机制

### 3.2 设备管理模块
- **功能描述**: 实现设备的添加、删除和状态管理
- **设备信息**: 设备ID、名称、状态、创建时间
- **关联关系**: 设备与用户的多对多关系

### 3.3 图片管理模块
- **功能描述**: 处理设备上传的图片，支持查看和删除
- **图片信息**: 设备ID、图片路径、原始文件名、接收时间
- **存储方式**: 文件系统存储 + 数据库记录

### 3.4 实时数据推送模块
- **功能描述**: 使用WebSocket实现实时数据推送
- **推送数据类型**: 新图片通知、设备状态变化、传感器数据
- **推送机制**: 事件驱动，服务器主动推送

## 4. API接口文档

### 4.1 认证接口

#### 4.1.1 用户登录
- **URL**: `/login`
- **方法**: `POST`
- **参数**:
  - `username`: 用户名/设备ID
  - `password`: 密码
- **返回**: 重定向到主页或错误页面

#### 4.1.2 获取当前用户信息
- **URL**: `/api/user_info`
- **方法**: `GET`
- **权限**: 登录用户
- **返回**: 用户信息JSON

### 4.2 设备管理接口

#### 4.2.1 获取设备列表
- **URL**: `/api/devices`
- **方法**: `GET`
- **权限**: 管理员
- **返回**: 设备列表JSON

### 4.3 图片管理接口

#### 4.3.1 查看图片
- **URL**: `/api/view_image/<image_id>`
- **方法**: `GET`
- **权限**: 登录用户
- **返回**: 图片信息JSON

#### 4.3.2 删除图片
- **URL**: `/api/delete_image/<image_id>`
- **方法**: `DELETE`
- **权限**: 管理员
- **功能**: 删除图片文件和记录，同时删除关联设备
- **返回**: 操作结果JSON

### 4.4 静态资源接口

#### 4.4.1 访问首页
- **URL**: `/`
- **方法**: `GET`
- **权限**: 登录用户
- **返回**: 设备列表页面HTML

#### 4.4.2 访问静态文件
- **URL**: `/static/<filename>`
- **方法**: `GET`
- **返回**: 静态资源文件

## 5. 数据库设计

### 5.1 数据库表结构

#### 5.1.1 用户表 (users)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 用户ID |
| username | TEXT | NOT NULL UNIQUE | 用户名 |
| password | TEXT | NOT NULL | 密码 |
| role | TEXT | NOT NULL DEFAULT 'device' | 用户角色 |
| device_id | TEXT | | 关联的设备ID |
| created_at | TEXT | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

#### 5.1.2 设备表 (devices)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| device_id | TEXT | PRIMARY KEY | 设备ID |
| name | TEXT | NOT NULL | 设备名称 |
| status | TEXT | DEFAULT 'active' | 设备状态 |
| created_at | TEXT | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

#### 5.1.3 图片表 (images)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 图片ID |
| device_id | TEXT | NOT NULL | 关联设备ID |
| image_path | TEXT | NOT NULL | 图片存储路径 |
| original_filename | TEXT | NOT NULL | 原始文件名 |
| receive_time | TEXT | NOT NULL | 接收时间 |

#### 5.1.4 用户设备关联表 (user_devices)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 关联ID |
| user_id | INTEGER | NOT NULL | 用户ID |
| device_id | TEXT | NOT NULL | 设备ID |
| created_at | TEXT | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

## 6. 前端功能

### 6.1 登录页面
- 支持用户名/设备ID登录
- 显示登录错误提示
- 提供登录信息说明

### 6.2 设备列表页面
- 实时显示设备列表
- 支持设备信息查看
- 支持图片预览和查看
- 支持图片删除功能

### 6.3 WebSocket实时通信
- 实时接收新图片通知
- 实时更新设备状态
- 维持长连接状态监控

### 6.4 图片管理功能
- 图片预览功能
- 图片查看功能
- 图片删除功能（删除图片时同时删除关联设备）

## 7. 后端功能

### 7.1 设备数据处理
- 接收设备上传的图片
- 存储设备数据到数据库
- 处理设备状态更新

### 7.2 实时数据推送
- 新图片通知推送
- 设备状态变化推送
- 传感器数据推送

### 7.3 图片管理
- 图片存储和路径管理
- 图片信息查询
- 图片删除（包括关联设备删除）

### 7.4 用户权限控制
- 基于角色的访问控制
- 会话管理
- API权限验证

## 8. 部署说明

### 8.1 环境准备
1. 安装Python 3.12
2. 创建虚拟环境: `python3 -m venv venv`
3. 激活虚拟环境: `source venv/bin/activate`
4. 安装依赖: `pip install flask flask_socketio eventlet gunicorn`

### 8.2 数据库初始化
- 运行应用时自动创建数据库表
- 初始管理员账号: admin/123456

### 8.3 启动应用
```bash
# 开发环境启动
python app.py

# 生产环境启动（推荐使用gunicorn）
gunicorn -k eventlet -w 1 app:app -b 0.0.0.0:5000
```

### 8.4 访问地址
- 前端访问: http://localhost:5000
- API访问: http://localhost:5000/api/

## 9. 使用指南

### 9.1 管理员登录
1. 在浏览器中输入地址: http://localhost:5000
2. 输入用户名: admin, 密码: 123456
3. 点击登录按钮

### 9.2 设备添加
- 设备会通过MQTT自动注册到系统
- 管理员可以在设备列表中查看和管理设备

### 9.3 图片管理
- **查看图片**: 点击设备列表中的图片缩略图
- **删除图片**: 点击图片操作栏中的删除按钮，系统会同时删除关联设备

### 9.4 实时监控
- 系统会通过WebSocket实时推送新图片通知
- 设备状态会实时更新

## 10. 故障排除

### 10.1 常见问题

#### 10.1.1 登录失败
- 检查用户名和密码是否正确
- 确认用户角色和权限
- 检查数据库连接是否正常

#### 10.1.2 图片无法上传
- 检查设备网络连接
- 检查MQTT服务器是否运行
- 检查图片存储路径权限

#### 10.1.3 图片删除后设备列表不更新
- 检查浏览器缓存
- 刷新页面或重新登录
- 检查后端API是否正常响应

### 10.2 日志查看
- 服务器日志会输出到控制台
- 可以通过修改代码添加文件日志

## 11. 功能更新日志

### 11.1 版本 002de49
- 更新.gitignore，添加app.log排除
- 移除iot.db追踪
- 修改核心文件，优化系统性能

### 11.2 主要功能修复
- 修复了前端变量重复声明问题
- 修复了图片删除后设备列表不更新问题
- 优化了数据库初始化流程
- 增强了系统稳定性

## 12. 设备端对接参数

### 12.1 MQTT对接参数

#### 12.1.1 基本配置
- **MQTT服务器地址**: 10.1.0.8
- **MQTT端口**: 1883
- **QoS等级**: 1（确保消息至少传递一次）
- **设备ID格式**: 允许字母、数字、下划线和连字符，长度3-20字符（正则表达式：`^[a-zA-Z0-9_-]{3,20}$`）

#### 12.1.2 主题结构

| 主题类型 | 主题格式 | 方向 | 描述 |
|----------|----------|------|------|
| 传感器数据 | `control/sensor_data/{device_id}` | 设备 → 服务器 | 设备发送传感器数据 |
| 控制命令 | `control/command/{device_id}` | 服务器 → 设备 | 服务器发送控制命令 |
| 确认消息 | `control/confirm/{device_id}` | 服务器 → 设备 | 服务器确认收到消息 |

#### 12.1.3 消息格式

##### 传感器数据消息
```json
{
  "timestamp": "2025-12-18T14:00:00",
  "temperature_inside": 25.5,
  "temperature_outside": 18.2,
  "humidity": 65.0,
  "duoj1": 123,
  "duoj2": 456,
  "duoj3": 789,
  "duoj4": 0,
  "feng1": 1,
  "feng2": 0,
  "jia": 1
}
```

##### 控制命令消息
```json
{
  "command": "restart",
  "params": {
    "delay": 5
  }
}
```

##### 确认消息
```json
{
  "device_id": "test_device_001",
  "message_id": "2025-12-18T14:00:00",
  "status": "success"
}
```

### 12.2 HTTP对接参数

#### 12.2.1 图片上传API
- **URL**: `http://10.1.0.8:5000/upload/image`
- **方法**: `POST`
- **Content-Type**: `multipart/form-data`

##### 请求参数
| 参数名 | 类型 | 是否必填 | 描述 |
|--------|------|----------|------|
| image | 文件 | 是 | 要上传的图片文件 |
| device_id | 字符串 | 否 | 设备ID（默认：unknown） |

##### 返回示例
```json
{
  "code": 200,
  "msg": "Upload success",
  "path": "/data/images/test_device_001_test_image.png",
  "filename": "test_device_001_test_image.png"
}
```

#### 12.2.2 其他API接口
| API路径 | 方法 | 描述 |
|---------|------|------|
| `/api/user_info` | GET | 获取当前用户信息（需要登录） |
| `/api/devices` | GET | 获取设备列表（管理员权限） |

### 12.3 自动设备注册
- 设备首次发送MQTT消息或HTTP请求时，系统会自动注册该设备
- 设备ID将作为设备的唯一标识
- 注册成功后，设备会显示在管理员的设备列表中

## 13. 联系方式

如有问题或建议，请联系系统管理员。

---

**文档生成时间**: 2025-12-18
**文档版本**: 1.1
**项目版本**: 002de49d9b1ece8099c6246a67310ad69395bf82
